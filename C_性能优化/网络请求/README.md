## 网络请求

* DNS映射
> 无论是HTTP还是Socket长连接，第一步都是DNS解析。域名根据层级「主机名.次级域名.顶级域名.根域名」去解析，每一级缓存生命周期不同。在iOS设备上几乎每次断网重连，重启设备都会使DNS缓存失效，触发重新查询。这一步的优化对请求的延迟来说至关重要。

* 请求压缩

> 1. 压缩单个Request的业务数据 ：DNS查询之后是TCP握手建立连接，并发送请求数据。对于TCP来说，单个IP包大小受限于MSS值即最大报文长度，大部分用户所处网络环境下每个包的大小约在1.5KB，新建立的HTTP连接由于TCP的slow start特性即慢启动特性，会导致网络吞吐量的降低，从而增加整体request的延迟。所以压缩网络请求业务数据，减少一个 Request 的IP包数量,尽可能降低请求延迟的用户感知。   
> 2. 合并多个Request ：减少发起请求的次数,既可以降低服务器响应的压力，又可以节省客户端流量。项目中，国家码、发帖所选的圈子名称与 id 以及全局配置项等都可以合并。

* 请求的安全性
> 可详见 [Cookie与HTTPS](https://github.com/itwyhuaing/OC-WYH/tree/master/Cookie与HTTPS)

* 合理的并发数
> 在一些多个Request集中产生的场景中(大批图片拉取下载)，设置合理的并发数尤为重要。并发数如果太小，会导致“劣质”的请求block住“优质”的请求；如果并发数太大，带宽有限的场景下，会增加请求的整体延迟。

* 多通道
> 现在不少有技术条件的团队都有自己的tcp长连接通道，技术再硬点的甚至配有UDP通道，UDP在丢包率高的网络环境下能极大的提高请求成功的概率。如果能同时具备HTTP，TCP，UDP三条网络通道，在某些场景下，如果不考虑流量（比如wifi），可以针对某个网络请求，两通道或者三通道齐发，对请求成功的速度和可靠性有明显的疗效，不过客户端和服务器都需要针对业务场景做去重。我工作过的一个IM App在发送消息的时候，就是Socket配合HTTP双通道工作。UDP在VOIP服务当中使用较多，不过据说淘宝这类大厂也部分启用了UDP。

* 可靠性保障与业务梯度划分
> 将项目所有请求分为三类，在可靠性保障上做区分。理论上我们应该尽可能让所有的请求成功率达到最高，但客户端的流量，带宽，手机电量，服务器的压力等都是有限的资源，所以我们采取的策略是只对关键性的网络请求做高强度的可靠性保障。


## 网络监控

* 网络环境监控
> 针对当前网络状态可实时监控 wifi 、 4G、 3G、 2G 各类网络环境。

* 请求成功率监控
> 必要的请求可以在网络环境准许的情况下再次发起数据请求。

##### 参考
* [深度优化iOS网络模块](http://www.cocoachina.com/ios/20161115/18085.html)
* [TCP 慢启动（slow start)报文观察](http://blog.csdn.net/abccheng/article/details/50504874)
* [tcp 慢启动 slow start](http://blog.csdn.net/huoqubing/article/details/6146696)


## HTTP 错误码

**参考**
[HTTP状态码-菜鸟教程](https://www.runoob.com/http/http-status-codes.html)、

### 1** - 信息，服务器收到请求，需要请求者继续执行操作

### 2** - 成功，操作被成功接收并处理

### 3** - 重定向，需要进一步的操作以完成请求

### 4** - 客户端错误，请求包含语法错误或无法完成请求


### 5** - 服务器错误，服务器在处理请求的过程中发生了错误

**502**
* 网管错误，意即和服务器通信失败。可能的原因：
  1. 不能访问服务器，有可能断网，开启了防火墙等，可通过 ping 命令来定位下。
  2. 服务器未启动，可以通过查看日志来定位这个问题，或者查看端口是否启动。
  3. 服务器请求太多，响应不了这个请求，这个表现为时好时坏，可以通过查看web 服务器的日志来定位。

**504**
* 网管超时，意即服务器作为网关或代理，但是没有及时从上游服务器收到请求。这通常意味着上游服务器已关闭（不响应网管/代理），而不是上游服务器和网管/代理在交换数据的协议上不一致。正常情况下是由于被请求服务器发送超时引起。
